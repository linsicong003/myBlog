<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Node 写一个爬虫(爬SSR) | Clancy小屋</title>
    <meta name="description" content="慢慢来   比较快">
    <link rel="icon" href="icon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta property="article:published_time" content="2020-05-26T00:00:00.000Z"><meta property="article:modified_time" content="2020-05-26T04:04:19.000Z"><meta property="og:site_name" content="Clancy小屋"><meta property="og:title" content="使用 Node 写一个爬虫(爬SSR)"><meta property="og:type" content="website"><meta property="og:url" content="/Front/2020-05-26-spiderSSR.html"><meta name="twitter:title" content="使用 Node 写一个爬虫(爬SSR)"><meta name="twitter:url" content="/Front/2020-05-26-spiderSSR.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="Front, 前端, 爬虫"><meta property="article:tag" content="Front"><meta property="article:tag" content="前端"><meta property="article:tag" content="爬虫">
    <link rel="preload" href="/assets/css/0.styles.e7b93798.css" as="style"><link rel="preload" href="/assets/js/app.fff8adea.js" as="script"><link rel="preload" href="/assets/js/3.a86c7ed3.js" as="script"><link rel="preload" href="/assets/js/2.76bfe4ca.js" as="script"><link rel="preload" href="/assets/js/1.e6878f8a.js" as="script"><link rel="preload" href="/assets/js/73.ea05f2fb.js" as="script"><link rel="prefetch" href="/assets/js/10.883d5ecf.js"><link rel="prefetch" href="/assets/js/11.af2878be.js"><link rel="prefetch" href="/assets/js/12.30e99b4a.js"><link rel="prefetch" href="/assets/js/13.9829a993.js"><link rel="prefetch" href="/assets/js/14.b8b91dc6.js"><link rel="prefetch" href="/assets/js/15.73e53a79.js"><link rel="prefetch" href="/assets/js/16.c3ea6b15.js"><link rel="prefetch" href="/assets/js/17.1918549e.js"><link rel="prefetch" href="/assets/js/18.01249963.js"><link rel="prefetch" href="/assets/js/19.ee4c60aa.js"><link rel="prefetch" href="/assets/js/20.4957fec0.js"><link rel="prefetch" href="/assets/js/21.5e6e8cb3.js"><link rel="prefetch" href="/assets/js/22.450be24b.js"><link rel="prefetch" href="/assets/js/23.f5191b2e.js"><link rel="prefetch" href="/assets/js/24.539bca25.js"><link rel="prefetch" href="/assets/js/25.82f7abce.js"><link rel="prefetch" href="/assets/js/26.50389fc7.js"><link rel="prefetch" href="/assets/js/27.6764cc3a.js"><link rel="prefetch" href="/assets/js/28.5e0b5520.js"><link rel="prefetch" href="/assets/js/29.d39d4c6b.js"><link rel="prefetch" href="/assets/js/30.87f2843f.js"><link rel="prefetch" href="/assets/js/31.a5851d9f.js"><link rel="prefetch" href="/assets/js/32.04e8b7e9.js"><link rel="prefetch" href="/assets/js/33.1f771387.js"><link rel="prefetch" href="/assets/js/34.9316b191.js"><link rel="prefetch" href="/assets/js/35.7986d701.js"><link rel="prefetch" href="/assets/js/36.60739f13.js"><link rel="prefetch" href="/assets/js/37.2de79b2c.js"><link rel="prefetch" href="/assets/js/38.b3fb4166.js"><link rel="prefetch" href="/assets/js/39.1fd51d82.js"><link rel="prefetch" href="/assets/js/40.198685e0.js"><link rel="prefetch" href="/assets/js/41.5a906177.js"><link rel="prefetch" href="/assets/js/42.6e8b9df5.js"><link rel="prefetch" href="/assets/js/43.09604296.js"><link rel="prefetch" href="/assets/js/44.d4980cf7.js"><link rel="prefetch" href="/assets/js/45.0b6cb5d7.js"><link rel="prefetch" href="/assets/js/46.549f7ff5.js"><link rel="prefetch" href="/assets/js/47.bad0dbdb.js"><link rel="prefetch" href="/assets/js/48.eab2707b.js"><link rel="prefetch" href="/assets/js/49.2dd75cf4.js"><link rel="prefetch" href="/assets/js/5.27446bd9.js"><link rel="prefetch" href="/assets/js/50.73028054.js"><link rel="prefetch" href="/assets/js/51.04ef34ee.js"><link rel="prefetch" href="/assets/js/52.9c45a72d.js"><link rel="prefetch" href="/assets/js/53.d5ba6fee.js"><link rel="prefetch" href="/assets/js/54.1725426f.js"><link rel="prefetch" href="/assets/js/55.9f1478c7.js"><link rel="prefetch" href="/assets/js/56.5266d7c4.js"><link rel="prefetch" href="/assets/js/57.25a4f9d8.js"><link rel="prefetch" href="/assets/js/58.3ac06efa.js"><link rel="prefetch" href="/assets/js/59.cb0bba75.js"><link rel="prefetch" href="/assets/js/6.b394bab5.js"><link rel="prefetch" href="/assets/js/60.234b29bf.js"><link rel="prefetch" href="/assets/js/61.091d18b5.js"><link rel="prefetch" href="/assets/js/62.dcbb1268.js"><link rel="prefetch" href="/assets/js/63.f6f191f7.js"><link rel="prefetch" href="/assets/js/64.82f91500.js"><link rel="prefetch" href="/assets/js/65.f4332ae5.js"><link rel="prefetch" href="/assets/js/66.387650b3.js"><link rel="prefetch" href="/assets/js/67.0f937279.js"><link rel="prefetch" href="/assets/js/68.9867f765.js"><link rel="prefetch" href="/assets/js/69.ac740020.js"><link rel="prefetch" href="/assets/js/7.335fe9b9.js"><link rel="prefetch" href="/assets/js/70.3d34a6e7.js"><link rel="prefetch" href="/assets/js/71.421bfe0c.js"><link rel="prefetch" href="/assets/js/72.e1b9ab0e.js"><link rel="prefetch" href="/assets/js/74.05f048ab.js"><link rel="prefetch" href="/assets/js/75.263c9e53.js"><link rel="prefetch" href="/assets/js/76.17256700.js"><link rel="prefetch" href="/assets/js/77.34e88f2c.js"><link rel="prefetch" href="/assets/js/78.0d3251ca.js"><link rel="prefetch" href="/assets/js/79.62aae7f3.js"><link rel="prefetch" href="/assets/js/8.6c55754e.js"><link rel="prefetch" href="/assets/js/80.2caa6237.js"><link rel="prefetch" href="/assets/js/81.49b7de31.js"><link rel="prefetch" href="/assets/js/82.b303a09f.js"><link rel="prefetch" href="/assets/js/83.c61b5022.js"><link rel="prefetch" href="/assets/js/84.1bb9bf5b.js"><link rel="prefetch" href="/assets/js/9.5684fee1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e7b93798.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="bg-container"><div id="particles-oli-wrapper" data-v-c339c0f6></div></div> <div class="main-container common"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/logo.jpg" alt="Clancy小屋" class="logo"> <span class="site-name">Clancy小屋</span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-gitlab"></i>
  首页
</a></div><div class="nav-item"><a href="/category/ET/" class="nav-link"><i class="iconfont reco-eye"></i>
  教育技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Front/" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/category/TS/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/category/Comment/" class="nav-link"><i class="iconfont undefined"></i>
  杂谈
</a></li><li class="dropdown-item"><!----> <a href="/DailyTest/Navigator.html" class="nav-link"><i class="iconfont undefined"></i>
  练题笔记
</a></li></ul></div></div><div class="nav-item"><a href="/timeLine.html" class="nav-link"><i class="iconfont reco-three"></i>
  时光机
</a></div><div class="nav-item"><a href="/AboutMe.html" class="nav-link"><i class="iconfont reco-other"></i>
  关于我
</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-6656a0de data-v-6656a0de><i class="iconfont reco-up" data-v-6656a0de></i></div> <div id="common" class="theme-container"><!----> <div id="mainContent" class="common-content"><div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-gitlab"></i>
  首页
</a></div><div class="nav-item"><a href="/category/ET/" class="nav-link"><i class="iconfont reco-eye"></i>
  教育技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Front/" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/category/TS/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/category/Comment/" class="nav-link"><i class="iconfont undefined"></i>
  杂谈
</a></li><li class="dropdown-item"><!----> <a href="/DailyTest/Navigator.html" class="nav-link"><i class="iconfont undefined"></i>
  练题笔记
</a></li></ul></div></div><div class="nav-item"><a href="/timeLine.html" class="nav-link"><i class="iconfont reco-three"></i>
  时光机
</a></div><div class="nav-item"><a href="/AboutMe.html" class="nav-link"><i class="iconfont reco-other"></i>
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>使用 Node 写一个爬虫(爬SSR)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Front/2020-05-26-spiderSSR.html#开始前准备" class="sidebar-link">开始前准备</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-05-26-spiderSSR.html#开始" class="sidebar-link">开始</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-05-26-spiderSSR.html#页面分析" class="sidebar-link">页面分析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-05-26-spiderSSR.html#代码撸起来" class="sidebar-link">代码撸起来</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Front/2020-05-26-spiderSSR.html#发邮件的工具函数" class="sidebar-link">发邮件的工具函数</a></li><li class="sidebar-sub-header"><a href="/Front/2020-05-26-spiderSSR.html#编写爬虫" class="sidebar-link">编写爬虫</a></li><li class="sidebar-sub-header"><a href="/Front/2020-05-26-spiderSSR.html#小优化" class="sidebar-link">小优化</a></li></ul></li><li><a href="/Front/2020-05-26-spiderSSR.html#小结" class="sidebar-link">小结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><div><main class="page reco-hide"> <div class="page-title"><h1>使用 Node 写一个爬虫(爬SSR)</h1> <hr> <div style="position:relative;" data-v-6e6f5ac2><i class="iconfont reco-account" data-v-6e6f5ac2><span data-v-6e6f5ac2>Clancy Lin</span></i> <i class="iconfont reco-date" data-v-6e6f5ac2><span data-v-6e6f5ac2>2020-5-26</span></i> <!----> <i class="iconfont reco-tag tags" data-v-6e6f5ac2><span class="tag-item" data-v-6e6f5ac2>Front</span><span class="tag-item" data-v-6e6f5ac2>前端</span><span class="tag-item" data-v-6e6f5ac2>爬虫</span></i> <span class="pageFull" data-v-6e6f5ac2>全屏</span></div></div> <div class="content__default"><p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200526-1.jpg" alt="封面图"></p> <p>一起开黑的同学L在某公考培训机构工作，最近他开始频繁缺席车队开黑，一问原来是等公告所以公司安排了值班</p> <p>我一想这不简单吗，写个小爬虫脚本监听变化，有新通知了邮件通知一下自己不就行了 😄</p> <p>省下的时间精力用来看书岂不美滋滋</p> <p>说干就干，马上开搞</p> <h2 id="开始前准备"><a href="#开始前准备" aria-hidden="true" class="header-anchor">#</a> 开始前准备</h2> <p>天下武功，唯快不破</p> <p>作为一个前端CV工程师，快速开发首选熟悉的 Node</p> <p>先做一下需求分析，想要熟悉的功能其实只有两个</p> <ul><li>⭐️ 监听页面公告的变化</li> <li>⭐️ 发邮件通知</li></ul> <p>需求确定的，后面要做的就是 <code>百度/谷歌</code> 了</p> <p>一番查找下来，最后确定了要用的工具库如下：</p> <ul><li><a href="https://github.com/axios/axios" target="_blank" rel="noopener noreferrer">axios<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：请求库，这里用来请求页面代码</li> <li><a href="https://github.com/cheeriojs/cheerio" target="_blank" rel="noopener noreferrer">cheerio<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：操作库，使用jq的方式来操作字符串</li> <li><a href="https://github.com/nodemailer/nodemailer" target="_blank" rel="noopener noreferrer">nodemailer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：发送邮件</li></ul> <p>准备好了要用的工具之后，就可以愉快的开始爬虫之旅啦~</p> <h2 id="开始"><a href="#开始" aria-hidden="true" class="header-anchor">#</a> 开始</h2> <p>首先我们还是要重复一遍需求，在官网有公告更新的时候自动发送一封邮件提醒自己</p> <p>接着我们打开某省公考招考网站信息发布的网站</p> <p>可以看到页面如下</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200526-2.jpg" alt="公考招考网站示意图"></p> <p>右键查看源代码之后发现是一个后端渲染的网站</p> <p>那我们不需要另外的处理了，简单粗暴直接爬就行了</p> <h2 id="页面分析"><a href="#页面分析" aria-hidden="true" class="header-anchor">#</a> 页面分析</h2> <p>对于一个爬虫软件来说，爬下页面代码后，最重要的就是对页面的结构进行分析了</p> <p>所以开始按下 <code>F12</code> 开启别样的 web 旅程~ 😏</p> <p>我们先来分析一下每一条消息的 DOM 结构</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200526-3.jpg" alt="公考DOM分析"></p> <p>把它复制出来，可以看到对应的 HTML 代码如下</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;/gwykl/20190312/15109.html&quot;</span> target<span class="token operator">=</span><span class="token string">&quot;_blank&quot;</span> title<span class="token operator">=</span><span class="token string">&quot;广东省2019年考试录用公务员公告&quot;</span><span class="token operator">&gt;</span>
    广东省<span class="token number">2019</span>年考试录用公务员公告
    <span class="token operator">&lt;</span>i<span class="token operator">&gt;</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>同时可以看出来</p> <p>整体的列表 DOM 是通过时间排好序的，分析到这里我们的思路已经非常明确了</p> <p>只需要监听列表中的第一个 DOM 元素，跟上次监听的不一样且包含 2020 字样就可以了~</p> <h2 id="代码撸起来"><a href="#代码撸起来" aria-hidden="true" class="header-anchor">#</a> 代码撸起来</h2> <p>在开始写爬虫逻辑之前，我们先写一个发送邮件的工具函数方便调用</p> <h3 id="发邮件的工具函数"><a href="#发邮件的工具函数" aria-hidden="true" class="header-anchor">#</a> 发邮件的工具函数</h3> <p>我们给这个函数定义两个入参，<code>text</code> 是邮件发送的内容，<code>subject</code> 是邮件发送的主题</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> nodemailer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nodemailer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 想要发送的邮箱列表</span>
<span class="token keyword">const</span> mailList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'xxxxx@163.com'</span><span class="token punctuation">]</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> subject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        text <span class="token operator">=</span> <span class="token string">'&lt;b&gt;Hello world?&lt;/b&gt;'</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建一个 nodemailer 实例</span>
    <span class="token keyword">let</span> transporter <span class="token operator">=</span> nodemailer<span class="token punctuation">.</span><span class="token function">createTransport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        service<span class="token punctuation">:</span> <span class="token string">'163'</span><span class="token punctuation">,</span> <span class="token comment">// 使用了内置传输发送邮件 查看支持列表：https://nodemailer.com/smtp/well-known/</span>
        port<span class="token punctuation">:</span> <span class="token number">465</span><span class="token punctuation">,</span> <span class="token comment">// SMTP 端口</span>
        secureConnection<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 使用了 SSL</span>
        auth<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            user<span class="token punctuation">:</span> <span class="token string">'xxxx'</span><span class="token punctuation">,</span>
            <span class="token comment">// 这里密码不是邮箱密码，是你设置的smtp授权码</span>
            pass<span class="token punctuation">:</span> <span class="token string">'xxxx'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">let</span> mailOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">from</span><span class="token punctuation">:</span>  <span class="token string">'&quot;xxx&quot; &lt;xxxx@163.com&gt;'</span><span class="token punctuation">,</span> <span class="token comment">// sender address</span>
        <span class="token comment">// to: 'xxx@163.com', // list of receivers</span>
        subject<span class="token punctuation">:</span> subject<span class="token punctuation">,</span> <span class="token comment">// Subject line</span>
        <span class="token comment">// 发送text或者html格式</span>
        <span class="token comment">// text: 'Hello world?', // plain text body</span>
        html<span class="token punctuation">:</span> text <span class="token comment">// html body</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
    <span class="token comment">// send mail with defined transport object</span>
    mailList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        mailOptions<span class="token punctuation">.</span>to <span class="token operator">=</span> item
        transporter<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>mailOptions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message sent: %s'</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Message sent: &lt;04ec7731-cc68-1ef6-303c-61b0f796b78f@qq.com&gt;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>到这里一个简单好用的邮件发送函数已经编写完成了，试试手动触发给自己发送一封邮件吧~</p> <h3 id="编写爬虫"><a href="#编写爬虫" aria-hidden="true" class="header-anchor">#</a> 编写爬虫</h3> <p>上面分析了这么多，终于可以开干了，其实逻辑也比价简单，一个主函数就可以搞定了</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cheerio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mail <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./mail'</span><span class="token punctuation">)</span>

<span class="token comment">// 准备爬取的网页</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://www.gdhrss.gov.cn/gwykl/index.html</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> baseUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://www.gdhrss.gov.cn</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// 记录上一次爬取时第一条消息</span>
<span class="token comment">// 防止反复发送</span>
<span class="token keyword">let</span> lastFirst <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token comment">// 记录爬取时间</span>
<span class="token keyword">let</span> lastCheck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">getPage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'MMMM Do YYYY, h:mm:ss a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'无数据'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

    <span class="token comment">// 获取当前列表首条信息的节点</span>
    <span class="token keyword">let</span> nowFirst <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.leftlist'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>attribs <span class="token operator">||</span> <span class="token keyword">null</span>
    <span class="token comment">// 如果当前无值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nowFirst<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 初始值无值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastFirst <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>nowFirst<span class="token punctuation">.</span>title<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'2020'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lastFirst <span class="token operator">=</span> nowFirst
        <span class="token function">mail</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'MMMM Do YYYY, h:mm:ss a'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">服务开始启动啦~</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'监听服务启动'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 没有更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nowFirst<span class="token punctuation">.</span>href <span class="token operator">===</span> lastFirst<span class="token punctuation">.</span>href <span class="token operator">&amp;&amp;</span> nowFirst<span class="token punctuation">.</span>title <span class="token operator">===</span> lastFirst<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 发现更新</span>
    lastFirst <span class="token operator">=</span> nowFirst
    <span class="token keyword">const</span> mailText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;center&gt;有新通知啦~&lt;/center&gt;&lt;p&gt;通知 &lt;b&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nowFirst<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/b&gt; 更新啦&lt;/p&gt;&lt;p&gt;通知地址是：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>baseUrl <span class="token operator">+</span> nowFirst<span class="token punctuation">.</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'MMMM Do YYYY, h:mm:ss a'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span>
    
    <span class="token comment">// 发送邮件</span>
    <span class="token function">mail</span><span class="token punctuation">(</span>mailText<span class="token punctuation">,</span> nowFirst<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>到这里我们爬虫的主函数已经大功告成了，接下来只要循环调用 <code>getPage</code> 函数即可</p> <p>这里的循环调用有非常多的实现方法，我这里给出我的实现：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sleep <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'system-sleep'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="小优化"><a href="#小优化" aria-hidden="true" class="header-anchor">#</a> 小优化</h3> <p>细心的同学肯定会发现，我们这个爬虫要挂在服务器上，小水管毕竟不太稳定，保不定啥时候就挂了（其实是怕我自己写的代码有bug~😄）</p> <p>监听程序存活状态有两种方式：</p> <ul><li>通过进程管理工具，服务挂了的时候自动重启或者发邮件通知（还要再开发，麻烦）</li> <li>定时给自己发心跳邮件，超过时间没收到就是服务挂了（方便~但是时长不能设的太短，不然自己会烦死hhh）</li></ul> <p>我这里选用第二种方式，设成一天检测一次服务状态</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 检查是否存活</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">-</span> lastCheck <span class="token operator">&gt;</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastCheck <span class="token operator">=</span> timestamp
    <span class="token function">mail</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'MMMM Do YYYY, h:mm:ss a'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">服务状态检查</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务还活着</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>把它传到服务器上直接跑，发现已经在监听啦~</p> <h2 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h2> <p>这里是单页面的爬虫，如果有多页面的需求还需要爬到页面上的导航页顺序爬取~</p> <p>这个小 demo 也可以看出爬虫其实没那么难</p> <p>下一篇我们来讨论一下 SPA 页面的爬取 😄</p></div> <!----> <footer class="page-edit"><!----></footer> <!----> </main></div> <div class="valine-wrapper" data-v-5d2e7f84><div id="valine" data-v-5d2e7f84></div></div></div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fff8adea.js" defer></script><script src="/assets/js/3.a86c7ed3.js" defer></script><script src="/assets/js/2.76bfe4ca.js" defer></script><script src="/assets/js/1.e6878f8a.js" defer></script><script src="/assets/js/73.ea05f2fb.js" defer></script>
  </body>
</html>
