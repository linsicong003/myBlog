<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>摸鱼之际一起来实现一个 Vuex | Clancy小屋</title>
    <meta name="description" content="慢慢来   比较快">
    <link rel="icon" href="icon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta property="article:published_time" content="2020-04-17T00:00:00.000Z"><meta property="article:modified_time" content="2020-04-17T09:55:57.000Z"><meta property="og:site_name" content="Clancy小屋"><meta property="og:title" content="摸鱼之际一起来实现一个 Vuex"><meta property="og:type" content="website"><meta property="og:url" content="/Front/2020-4-17-myVuex.html"><meta name="twitter:title" content="摸鱼之际一起来实现一个 Vuex"><meta name="twitter:url" content="/Front/2020-4-17-myVuex.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="Front, 前端, Vue原理"><meta property="article:tag" content="Front"><meta property="article:tag" content="前端"><meta property="article:tag" content="Vue原理">
    <link rel="preload" href="/assets/css/0.styles.e7b93798.css" as="style"><link rel="preload" href="/assets/js/app.ebbf034c.js" as="script"><link rel="preload" href="/assets/js/3.a86c7ed3.js" as="script"><link rel="preload" href="/assets/js/2.76bfe4ca.js" as="script"><link rel="preload" href="/assets/js/1.e6878f8a.js" as="script"><link rel="preload" href="/assets/js/76.713ac99a.js" as="script"><link rel="prefetch" href="/assets/js/10.3e85fa6c.js"><link rel="prefetch" href="/assets/js/11.ad5e0bb1.js"><link rel="prefetch" href="/assets/js/12.b505bd56.js"><link rel="prefetch" href="/assets/js/13.16384a1b.js"><link rel="prefetch" href="/assets/js/14.1a0ba328.js"><link rel="prefetch" href="/assets/js/15.4b4d9239.js"><link rel="prefetch" href="/assets/js/16.3b16ee21.js"><link rel="prefetch" href="/assets/js/17.74d5e03f.js"><link rel="prefetch" href="/assets/js/18.77d6c522.js"><link rel="prefetch" href="/assets/js/19.f4541ff2.js"><link rel="prefetch" href="/assets/js/20.ef2b74b1.js"><link rel="prefetch" href="/assets/js/21.3ec6819a.js"><link rel="prefetch" href="/assets/js/22.c1b42fce.js"><link rel="prefetch" href="/assets/js/23.ec6db625.js"><link rel="prefetch" href="/assets/js/24.d6c42f97.js"><link rel="prefetch" href="/assets/js/25.5b23b8a7.js"><link rel="prefetch" href="/assets/js/26.1fabb0f8.js"><link rel="prefetch" href="/assets/js/27.d85bc1af.js"><link rel="prefetch" href="/assets/js/28.e8e8ba0b.js"><link rel="prefetch" href="/assets/js/29.7f38c340.js"><link rel="prefetch" href="/assets/js/30.681ee788.js"><link rel="prefetch" href="/assets/js/31.ff6f2f8d.js"><link rel="prefetch" href="/assets/js/32.b9775a9f.js"><link rel="prefetch" href="/assets/js/33.2c9ec258.js"><link rel="prefetch" href="/assets/js/34.85ccd09a.js"><link rel="prefetch" href="/assets/js/35.9fdb6a65.js"><link rel="prefetch" href="/assets/js/36.d28119fa.js"><link rel="prefetch" href="/assets/js/37.28e5f766.js"><link rel="prefetch" href="/assets/js/38.834da2bb.js"><link rel="prefetch" href="/assets/js/39.2423cf23.js"><link rel="prefetch" href="/assets/js/40.167a06e8.js"><link rel="prefetch" href="/assets/js/41.18177fce.js"><link rel="prefetch" href="/assets/js/42.5333206f.js"><link rel="prefetch" href="/assets/js/43.ac731ec2.js"><link rel="prefetch" href="/assets/js/44.49162ddc.js"><link rel="prefetch" href="/assets/js/45.d270fdea.js"><link rel="prefetch" href="/assets/js/46.485589ba.js"><link rel="prefetch" href="/assets/js/47.3eca643a.js"><link rel="prefetch" href="/assets/js/48.137e27b9.js"><link rel="prefetch" href="/assets/js/49.eb9e0216.js"><link rel="prefetch" href="/assets/js/5.27446bd9.js"><link rel="prefetch" href="/assets/js/50.993d02c1.js"><link rel="prefetch" href="/assets/js/51.4c5f3f3c.js"><link rel="prefetch" href="/assets/js/52.24a10c64.js"><link rel="prefetch" href="/assets/js/53.770aeee9.js"><link rel="prefetch" href="/assets/js/54.9455cebe.js"><link rel="prefetch" href="/assets/js/55.d300c846.js"><link rel="prefetch" href="/assets/js/56.60ecfe3a.js"><link rel="prefetch" href="/assets/js/57.c5817f43.js"><link rel="prefetch" href="/assets/js/58.f16fb28c.js"><link rel="prefetch" href="/assets/js/59.136b72d1.js"><link rel="prefetch" href="/assets/js/6.bfea56f2.js"><link rel="prefetch" href="/assets/js/60.3e72766b.js"><link rel="prefetch" href="/assets/js/61.be4517df.js"><link rel="prefetch" href="/assets/js/62.0eaf1bb9.js"><link rel="prefetch" href="/assets/js/63.ee5e5ad8.js"><link rel="prefetch" href="/assets/js/64.9f9b3d58.js"><link rel="prefetch" href="/assets/js/65.6749418f.js"><link rel="prefetch" href="/assets/js/66.d6271af3.js"><link rel="prefetch" href="/assets/js/67.be4295b2.js"><link rel="prefetch" href="/assets/js/68.06237718.js"><link rel="prefetch" href="/assets/js/69.72b9d540.js"><link rel="prefetch" href="/assets/js/7.8b56e7b5.js"><link rel="prefetch" href="/assets/js/70.f4350cb3.js"><link rel="prefetch" href="/assets/js/71.21f68007.js"><link rel="prefetch" href="/assets/js/72.e39b3a92.js"><link rel="prefetch" href="/assets/js/73.d1ee68d3.js"><link rel="prefetch" href="/assets/js/74.8c579d80.js"><link rel="prefetch" href="/assets/js/75.9d7437ba.js"><link rel="prefetch" href="/assets/js/77.75933259.js"><link rel="prefetch" href="/assets/js/78.351a9591.js"><link rel="prefetch" href="/assets/js/79.e6167a97.js"><link rel="prefetch" href="/assets/js/8.88029ea1.js"><link rel="prefetch" href="/assets/js/80.5da6ce51.js"><link rel="prefetch" href="/assets/js/81.3925e712.js"><link rel="prefetch" href="/assets/js/82.8eb2404d.js"><link rel="prefetch" href="/assets/js/83.c7716849.js"><link rel="prefetch" href="/assets/js/9.710d07f6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e7b93798.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="bg-container"><div id="particles-oli-wrapper" data-v-c339c0f6></div></div> <div class="main-container common"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/logo.jpg" alt="Clancy小屋" class="logo"> <span class="site-name">Clancy小屋</span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-gitlab"></i>
  首页
</a></div><div class="nav-item"><a href="/category/ET/" class="nav-link"><i class="iconfont reco-eye"></i>
  教育技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Front/" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/category/TS/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/category/Comment/" class="nav-link"><i class="iconfont undefined"></i>
  杂谈
</a></li><li class="dropdown-item"><!----> <a href="/DailyTest/Navigator.html" class="nav-link"><i class="iconfont undefined"></i>
  练题笔记
</a></li></ul></div></div><div class="nav-item"><a href="/timeLine.html" class="nav-link"><i class="iconfont reco-three"></i>
  时光机
</a></div><div class="nav-item"><a href="/AboutMe.html" class="nav-link"><i class="iconfont reco-other"></i>
  关于我
</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-6656a0de data-v-6656a0de><i class="iconfont reco-up" data-v-6656a0de></i></div> <div id="common" class="theme-container"><!----> <div id="mainContent" class="common-content"><div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-gitlab"></i>
  首页
</a></div><div class="nav-item"><a href="/category/ET/" class="nav-link"><i class="iconfont reco-eye"></i>
  教育技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Front/" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/category/TS/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/category/Comment/" class="nav-link"><i class="iconfont undefined"></i>
  杂谈
</a></li><li class="dropdown-item"><!----> <a href="/DailyTest/Navigator.html" class="nav-link"><i class="iconfont undefined"></i>
  练题笔记
</a></li></ul></div></div><div class="nav-item"><a href="/timeLine.html" class="nav-link"><i class="iconfont reco-three"></i>
  时光机
</a></div><div class="nav-item"><a href="/AboutMe.html" class="nav-link"><i class="iconfont reco-other"></i>
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>摸鱼之际一起来实现一个 Vuex</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Front/2020-4-17-myVuex.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#先说说双向绑定" class="sidebar-link">先说说双向绑定</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#vuex-功能测试准备" class="sidebar-link">Vuex 功能测试准备</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#使用-vue-双向绑定构建-state" class="sidebar-link">使用 Vue 双向绑定构建 state</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#实现-getters" class="sidebar-link">实现 getters</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#mutations-和-actions-实现" class="sidebar-link">mutations 和 actions 实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#实现入口加载函数" class="sidebar-link">实现入口加载函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#实现效果" class="sidebar-link">实现效果</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#结语" class="sidebar-link">结语</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2020-4-17-myVuex.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><div><main class="page reco-hide"> <div class="page-title"><h1>摸鱼之际一起来实现一个 Vuex</h1> <hr> <div style="position:relative;" data-v-6e6f5ac2><i class="iconfont reco-account" data-v-6e6f5ac2><span data-v-6e6f5ac2>Clancy Lin</span></i> <i class="iconfont reco-date" data-v-6e6f5ac2><span data-v-6e6f5ac2>2020-4-17</span></i> <!----> <i class="iconfont reco-tag tags" data-v-6e6f5ac2><span class="tag-item" data-v-6e6f5ac2>Front</span><span class="tag-item" data-v-6e6f5ac2>前端</span><span class="tag-item" data-v-6e6f5ac2>Vue原理</span></i> <span class="pageFull" data-v-6e6f5ac2>全屏</span></div></div> <div class="content__default"><p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200417-1.jpg" alt="开篇图"></p> <h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2> <p>如果你用过 <code>Vue</code>，那么 <code>Vuex</code> 必定是你使用过程中无法绕过的一道坎。</p> <p>用过以后你有没有想过，</p> <p>他的内部原理究竟是怎么样的呢？</p> <p>今天我们就通过对其简单的实现，</p> <p>一起来探究它内部的原理。 😄</p> <p>这里就默认大家已经用过 <code>Vuex</code> 并且对它的操作还比较熟悉了，</p> <p>如果还不熟悉的同学可以异步 <a href="https://vuex.vuejs.org/zh/guide/" target="_blank" rel="noopener noreferrer">官网教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="先说说双向绑定"><a href="#先说说双向绑定" aria-hidden="true" class="header-anchor">#</a> 先说说双向绑定</h2> <p>用过的同学应该都会对 <code>Vuex</code> 强大的数据管理能力印象深刻，</p> <p>那么操作 <code>Vuex</code> 中的数据是怎么让渲染视图实时更新的呢？</p> <p>没错，这时候老大哥 <code>Vue</code> 就要出场了。</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200417-2.jpg" alt="出场"></p> <p>编程是门黑魔法，下面这种操作不知道在你的代码中有没有出现过， 😏</p> <p>（如果你不知道，权当开个眼界嘿嘿。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 创建一个全新的 Vue 实例</span>
<span class="token keyword">const</span> bus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 将其挂载到当前项目实例</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$bus <span class="token operator">=</span> bus

<span class="token comment">// 进行通信</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$bus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'call'</span><span class="token punctuation">,</span> <span class="token string">'呼叫'</span><span class="token punctuation">)</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>$bus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'call'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'收到'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这是一个使用 <code>Vue</code> 实例进行全局通信的例子，其优点和缺点都非常的明显，</p> <p>但是今天的重点并不是要讲这个。</p> <p>不知道大家有没有注意到我们在实现通信的过程中实际使用了 <code>Vue</code> 中的 <code>$emit</code> 和 <code>$on</code> 的方法，</p> <p>这给了我们启发，</p> <p>我们能不能让 <code>Vue</code> 中已有的双向绑定为我们所用呢？</p> <p>说干就干！</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200417-3.jpg" alt="开始表演"></p> <h2 id="vuex-功能测试准备"><a href="#vuex-功能测试准备" aria-hidden="true" class="header-anchor">#</a> Vuex 功能测试准备</h2> <p>在开始搭建我们自己的 <code>Vuex</code> 前，我们先预先设定好像要实现的功能，</p> <p>方便我们在开发过程中随时进行测试。</p> <p>最后的效果如下：</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200417-4.jpg" alt="测试界面"></p> <p>左边按钮中的数字依赖于仓库中的 <code>count</code> 变量，且每次点击都加1。</p> <p>接着我们编写好调用 <code>Vuex</code> 的代码，使用方法同官方库：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> MyVuex <span class="token keyword">from</span> <span class="token string">'./myVuex'</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>MyVuex<span class="token punctuation">)</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyVuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> state<span class="token punctuation">.</span>count
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">getOne</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">doCount</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">.</span>count <span class="token operator">=</span> data
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">doCount</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'doCount'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">doCountDouble</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'doCount'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> store
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>万事具备之后就可以正式开始开发了！</p> <p><code>Vuex</code> 的核心主要有那么四部分：</p> <ul><li>⭐️ <code>state</code></li> <li>⭐️ <code>getters</code></li> <li>⭐️ <code>mutations</code></li> <li>⭐️ <code>actions</code></li></ul> <p>下面我们来一一对这些部分进行剖析吧</p> <h2 id="使用-vue-双向绑定构建-state"><a href="#使用-vue-双向绑定构建-state" aria-hidden="true" class="header-anchor">#</a> 使用 Vue 双向绑定构建 state</h2> <p>上面我们提到过，数据处理的核心其实还是利用了 <code>Vue</code> 的双向绑定，</p> <p>遵从着这个思路我们可以搭出整个库的雏形：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有 Vue 时先装上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Vue <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">install</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取配置</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options
        <span class="token comment">// 新建 Vue 实例响应式存储</span>
        <span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 新建 Vue 实例</span>
<span class="token keyword">function</span> <span class="token function">resetStoreVM</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先看有没有旧实例</span>
    <span class="token keyword">const</span> oldVm <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Vue<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span>oldVm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// store.getters = {}</span>

    store<span class="token punctuation">.</span>_vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          $$state<span class="token punctuation">:</span> state
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>这时候我们把 <code>Store</code> 的实例打印出来，就能看到我们的 <code>state</code> 已经被加载好了。 😄</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200417-5.jpg" alt="state的值"></p> <h2 id="实现-getters"><a href="#实现-getters" aria-hidden="true" class="header-anchor">#</a> 实现 getters</h2> <p>上面我们已经成功加载好了 <code>state</code>，</p> <p>但是一般而言并不推荐直接取值，而是最好通过 <code>getters</code> 进行值的获取，方便进行二次加工。</p> <p>在实现 <code>getters</code> 之前，我们先来看看文档中的说明。</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200417-6.jpg" alt="getters文档说明"></p> <p>文档中说明 <code>getters</code> 的值是有缓存优化策略的，但是我们这里为了方便就直接每次都使用 <code>新计算</code> 的值，</p> <p>如果有感兴趣的同学可在源码搜索 <code>store._makeLocalGettersCache</code> 的相关代码。</p> <p>现在我们的代码变成了这个样子：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有 Vue 时先装上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Vue <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">install</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取配置</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options

        <span class="token keyword">this</span><span class="token punctuation">.</span>getters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

        <span class="token comment">// 装载 getters</span>
        <span class="token function">forEachValue</span><span class="token punctuation">(</span>getters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 新建 Vue 实例响应式存储</span>
        <span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 注册 getter 函数</span>
<span class="token keyword">function</span> <span class="token function">registerGetter</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>_state<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">forEachValue</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>利用了 ES5 的 <code>Object.defineProperty</code> 进行拦截，每次调用取值都返回函数运行的结果，</p> <div class="tip custom-block"><p>也可以使用 <code>Proxy</code> 完成拦截，感兴趣的同学可以自己实现一下</p></div> <p>我们测试图例的按钮使用 <code>getters</code> 进行取值，进行到这里已经能在按钮上看到这个值了！</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/2020417-7.jpg" alt="getters效果"></p> <h2 id="mutations-和-actions-实现"><a href="#mutations-和-actions-实现" aria-hidden="true" class="header-anchor">#</a> mutations 和 actions 实现</h2> <p>单纯的数据获取是苍白的，接下来我们就来实现数据变化的黑魔法。</p> <p>因为简单版本的 <code>mutations</code> 和 <code>actions</code> 实现大同小异，</p> <p>所以我们这里就放在一起进行实现了。</p> <p>需要注意的是这里的 <code>mutation</code> 必须使用 <code>commit</code> 进行调用，这里使用 <code>_committing</code> 对其加锁。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span><span class="token punctuation">.</span>

    <span class="token comment">// 执行函数并加锁</span>
    <span class="token function">_withCommit</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> committing <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_committing
        <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> committing
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这里我们梳理一下 <code>mutations</code> 和 <code>actions</code> 的建构流程，</p> <ul><li>⭐️ 循环配置中的对应函数加载到 <code>Store</code> 的对应位置</li> <li>⭐️ 定义好 <code>commit</code> 和 <code>dispatch</code> 方法使其指向我们存储处理函数的位置</li> <li>⭐️ 处理好调用时的 <code>this</code> 指向</li></ul> <p>清晰了流程之后我们最后的实现代码就是下面这样的：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Vue <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">install</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> mutations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> actions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options
        
        <span class="token comment">// 初始化</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_state <span class="token operator">=</span> state
        <span class="token keyword">this</span><span class="token punctuation">.</span>_actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> commit <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">this</span>

        <span class="token comment">// 装载 getters</span>
        <span class="token function">forEachValue</span><span class="token punctuation">(</span>getters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 装载 mutations 和 actions</span>
        <span class="token function">forEachValue</span><span class="token punctuation">(</span>mutations<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">forEachValue</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">registerAction</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">boundDispatch</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">commit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">boundCommit</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">commit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 新建 Vue 实例响应式存储</span>
        <span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">get</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
    <span class="token punctuation">}</span>

    <span class="token comment">// 禁止再赋值</span>
    <span class="token keyword">set</span> <span class="token function">state</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'不允许赋值！！！'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// commit</span>
    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vuex] unknown mutation type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 执行对应处理函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">entry</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// dispatch</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vuex] unknown action type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        
        <span class="token function">entry</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 执行函数并加锁</span>
    <span class="token function">_withCommit</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> committing <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_committing
        <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> committing
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><p>看到这里有没有长呼一口气的感觉~~</p> <p>先别松懈，我们还有最后一个问题，</p> <p>为了模仿原库中 <code>Vue.use()</code> 的安装方式，</p> <p>我们还需要提供一个 <code>install</code> 函数</p> <h2 id="实现入口加载函数"><a href="#实现入口加载函数" aria-hidden="true" class="header-anchor">#</a> 实现入口加载函数</h2> <p>这部分的内容其实就只有两件事情要做：</p> <ul><li>⭐️ 取到 <code>Store</code> 实例并将其挂载到 <code>this.$store</code> 上</li> <li>⭐️ 将其混入我们的项目中</li></ul> <p>这部分的源码非常好理解，</p> <p>所以这里我就直接对源码进行搬运了~~~</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 安装方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">_Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Vue <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
          <span class="token string">'[vuex] already installed. Vue.use(Vuex) should be called only once.'</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    Vue <span class="token operator">=</span> _Vue
    <span class="token comment">// 取得 Vue 实例后混入</span>
    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> beforeCreate<span class="token punctuation">:</span> vuexInit <span class="token punctuation">}</span><span class="token punctuation">)</span>   
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Vuex init hook, injected into each instances init hooks list.
 * 初始化 Vuex
 */</span>
<span class="token keyword">function</span> <span class="token function">vuexInit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 组件内部有 store,则优先使用原有的store  </span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>store <span class="token operator">===</span> <span class="token string">'function'</span>
        <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> options<span class="token punctuation">.</span>store
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 组件没有 store 则继承根节点的 $store</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="实现效果"><a href="#实现效果" aria-hidden="true" class="header-anchor">#</a> 实现效果</h2> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20200417.gif" alt="实现效果"></p> <p><a href="https://github.com/linsicong003/vuex-annotation/tree/master/myVuex" target="_blank" rel="noopener noreferrer">完整代码戳这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>觉得有用的记得⭐️一下哦~~</p> <h2 id="结语"><a href="#结语" aria-hidden="true" class="header-anchor">#</a> 结语</h2> <p>知其然也要知其所以然，</p> <p>阅读源码一方面让我们了解到框架内部的实现原理，遏制住会产生 bug 的骚操作，</p> <p>另一方面也可以学习精妙的写法，对自己的编程风格有所启发。 😄</p> <p>谢谢大渣！</p> <p>-- 完 --</p> <p>欢迎关注我的<a href="linsicong.com">个人网站</a>啦啦啦~</p> <p>不定期更新前端内容。 😏</p> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <ul><li>https://juejin.im/post/5a7a935851882524713dcd05</li> <li>https://juejin.im/post/5d863ff66fb9a06ada54ed03</li> <li>https://juejin.im/post/5c62ea95e51d457ffe60c084</li> <li>Vuex 源码 v3.1.3</li></ul></div> <!----> <footer class="page-edit"><!----></footer> <!----> </main></div> <div class="valine-wrapper" data-v-5d2e7f84><div id="valine" data-v-5d2e7f84></div></div></div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ebbf034c.js" defer></script><script src="/assets/js/3.a86c7ed3.js" defer></script><script src="/assets/js/2.76bfe4ca.js" defer></script><script src="/assets/js/1.e6878f8a.js" defer></script><script src="/assets/js/76.713ac99a.js" defer></script>
  </body>
</html>
