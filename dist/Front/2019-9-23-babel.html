<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手把手写出第一个 Babel 插件 | Clancy小屋</title>
    <meta name="description" content="慢慢来   比较快">
    <link rel="icon" href="icon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta property="article:published_time" content="2019-09-23T00:00:00.000Z"><meta property="article:modified_time" content="2019-10-30T08:08:34.000Z"><meta property="og:site_name" content="Clancy小屋"><meta property="og:title" content="手把手写出第一个 Babel 插件"><meta property="og:type" content="website"><meta property="og:url" content="/Front/2019-9-23-babel.html"><meta property="og:image" content="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20190923-bg.jpg"><meta name="twitter:title" content="手把手写出第一个 Babel 插件"><meta name="twitter:url" content="/Front/2019-9-23-babel.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20190923-bg.jpg"><meta name="twitter:label1" content="Written by"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="Front, 前端, Babel"><meta property="article:tag" content="Front"><meta property="article:tag" content="前端"><meta property="article:tag" content="Babel">
    <link rel="preload" href="/assets/css/0.styles.15fdb5db.css" as="style"><link rel="preload" href="/assets/js/app.d305619e.js" as="script"><link rel="preload" href="/assets/js/3.23866648.js" as="script"><link rel="preload" href="/assets/js/2.e3159806.js" as="script"><link rel="preload" href="/assets/js/1.2ccdfbe4.js" as="script"><link rel="preload" href="/assets/js/55.6fe1c081.js" as="script"><link rel="prefetch" href="/assets/js/10.4fb52131.js"><link rel="prefetch" href="/assets/js/11.1c8b15a0.js"><link rel="prefetch" href="/assets/js/12.24388ac3.js"><link rel="prefetch" href="/assets/js/13.3e6611c4.js"><link rel="prefetch" href="/assets/js/14.c19013b6.js"><link rel="prefetch" href="/assets/js/15.c7d9d9f3.js"><link rel="prefetch" href="/assets/js/16.118f5b8a.js"><link rel="prefetch" href="/assets/js/17.830bc552.js"><link rel="prefetch" href="/assets/js/18.901939c7.js"><link rel="prefetch" href="/assets/js/19.42819e88.js"><link rel="prefetch" href="/assets/js/20.4e4af900.js"><link rel="prefetch" href="/assets/js/21.e58b5539.js"><link rel="prefetch" href="/assets/js/22.f32cf05f.js"><link rel="prefetch" href="/assets/js/23.be631329.js"><link rel="prefetch" href="/assets/js/24.e5987bfa.js"><link rel="prefetch" href="/assets/js/25.626e861a.js"><link rel="prefetch" href="/assets/js/26.bbc568de.js"><link rel="prefetch" href="/assets/js/27.fcaa99e3.js"><link rel="prefetch" href="/assets/js/28.0b63f7cc.js"><link rel="prefetch" href="/assets/js/29.669bc714.js"><link rel="prefetch" href="/assets/js/30.8894b7db.js"><link rel="prefetch" href="/assets/js/31.cab9ec0f.js"><link rel="prefetch" href="/assets/js/32.4564975d.js"><link rel="prefetch" href="/assets/js/33.bb913eff.js"><link rel="prefetch" href="/assets/js/34.ecdd4d57.js"><link rel="prefetch" href="/assets/js/35.3a47ada8.js"><link rel="prefetch" href="/assets/js/36.18064928.js"><link rel="prefetch" href="/assets/js/37.b53d3a87.js"><link rel="prefetch" href="/assets/js/38.0974d85b.js"><link rel="prefetch" href="/assets/js/39.2cd25f51.js"><link rel="prefetch" href="/assets/js/40.c5878938.js"><link rel="prefetch" href="/assets/js/41.3743d824.js"><link rel="prefetch" href="/assets/js/42.2e17c330.js"><link rel="prefetch" href="/assets/js/43.325f8f0b.js"><link rel="prefetch" href="/assets/js/44.21a3289c.js"><link rel="prefetch" href="/assets/js/45.974821f2.js"><link rel="prefetch" href="/assets/js/46.f488385a.js"><link rel="prefetch" href="/assets/js/47.48274c91.js"><link rel="prefetch" href="/assets/js/48.c3d37f32.js"><link rel="prefetch" href="/assets/js/49.cceb4583.js"><link rel="prefetch" href="/assets/js/5.8be01bd2.js"><link rel="prefetch" href="/assets/js/50.147fb4fd.js"><link rel="prefetch" href="/assets/js/51.858e674e.js"><link rel="prefetch" href="/assets/js/52.74084612.js"><link rel="prefetch" href="/assets/js/53.5c04879c.js"><link rel="prefetch" href="/assets/js/54.17d1cadf.js"><link rel="prefetch" href="/assets/js/56.45b66bec.js"><link rel="prefetch" href="/assets/js/57.b7bc4e8b.js"><link rel="prefetch" href="/assets/js/58.9ad9d819.js"><link rel="prefetch" href="/assets/js/59.744d8e68.js"><link rel="prefetch" href="/assets/js/6.cc0cb41a.js"><link rel="prefetch" href="/assets/js/60.07898d2e.js"><link rel="prefetch" href="/assets/js/61.0db870bd.js"><link rel="prefetch" href="/assets/js/62.eb6ffe21.js"><link rel="prefetch" href="/assets/js/63.cf6fefad.js"><link rel="prefetch" href="/assets/js/64.d669b769.js"><link rel="prefetch" href="/assets/js/65.0b25a838.js"><link rel="prefetch" href="/assets/js/66.fb0121d2.js"><link rel="prefetch" href="/assets/js/67.13245020.js"><link rel="prefetch" href="/assets/js/68.b2bb3e49.js"><link rel="prefetch" href="/assets/js/69.beac2730.js"><link rel="prefetch" href="/assets/js/7.0c58288e.js"><link rel="prefetch" href="/assets/js/70.94f83eeb.js"><link rel="prefetch" href="/assets/js/71.a1951cd3.js"><link rel="prefetch" href="/assets/js/72.0ac97dcc.js"><link rel="prefetch" href="/assets/js/73.69e47490.js"><link rel="prefetch" href="/assets/js/8.3bb60c6f.js"><link rel="prefetch" href="/assets/js/9.e4471ed3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.15fdb5db.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="bg-container"><div id="particles-oli-wrapper" data-v-c339c0f6></div></div> <div class="main-container common"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/logo.jpg" alt="Clancy小屋" class="logo"> <span class="site-name">Clancy小屋</span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-gitlab"></i>
  首页
</a></div><div class="nav-item"><a href="/category/IT/" class="nav-link"><i class="iconfont reco-eye"></i>
  教育技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Front/" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/category/TS/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/category/Comment/" class="nav-link"><i class="iconfont undefined"></i>
  杂谈
</a></li></ul></div></div><div class="nav-item"><a href="/DailyTest/Navigator.html" class="nav-link"><i class="iconfont reco-three"></i>
  每日练题
</a></div><div class="nav-item"><a href="/timeLine.html" class="nav-link"><i class="iconfont reco-npm"></i>
  时光机
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-other"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/About/" class="nav-link"><i class="iconfont undefined"></i>
  关于我
</a></li></ul></div></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-6656a0de data-v-6656a0de><i class="iconfont reco-up" data-v-6656a0de></i></div> <div id="common" class="theme-container"><div class="common"><div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-gitlab"></i>
  首页
</a></div><div class="nav-item"><a href="/category/IT/" class="nav-link"><i class="iconfont reco-eye"></i>
  教育技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Front/" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/category/TS/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/category/Comment/" class="nav-link"><i class="iconfont undefined"></i>
  杂谈
</a></li></ul></div></div><div class="nav-item"><a href="/DailyTest/Navigator.html" class="nav-link"><i class="iconfont reco-three"></i>
  每日练题
</a></div><div class="nav-item"><a href="/timeLine.html" class="nav-link"><i class="iconfont reco-npm"></i>
  时光机
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-other"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/About/" class="nav-link"><i class="iconfont undefined"></i>
  关于我
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>手把手写出第一个 Babel 插件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Front/2019-9-23-babel.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2019-9-23-babel.html#原理分析" class="sidebar-link">原理分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#babel-编译原理" class="sidebar-link">Babel 编译原理 🎏</a></li><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#ast-语法树" class="sidebar-link">AST 语法树 🎏</a></li><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#编译原理" class="sidebar-link">编译原理 🎏</a></li></ul></li><li><a href="/Front/2019-9-23-babel.html#使用-babel-进行转换" class="sidebar-link">使用 Babel 进行转换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#babel-基本使用" class="sidebar-link">Babel 基本使用 🎏</a></li><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#babel-api" class="sidebar-link">Babel API 🎏</a></li><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#vistor-api" class="sidebar-link">Vistor API 🎏</a></li></ul></li><li><a href="/Front/2019-9-23-babel.html#第一个插件" class="sidebar-link">第一个插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#环境准备" class="sidebar-link">环境准备 🎏</a></li><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#第一个例子" class="sidebar-link">第一个例子 🎏</a></li><li class="sidebar-sub-header"><a href="/Front/2019-9-23-babel.html#箭头函数的替换" class="sidebar-link">箭头函数的替换 🎏</a></li></ul></li><li><a href="/Front/2019-9-23-babel.html#结语" class="sidebar-link">结语</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Front/2019-9-23-babel.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>手把手写出第一个 Babel 插件</h1> <hr> <div style="position:relative;" data-v-6e6f5ac2><i class="iconfont reco-account" data-v-6e6f5ac2><span data-v-6e6f5ac2>Clancy Lin</span></i> <i class="iconfont reco-date" data-v-6e6f5ac2><span data-v-6e6f5ac2>2019-9-23</span></i> <!----> <i class="iconfont reco-tag tags" data-v-6e6f5ac2><span class="tag-item" data-v-6e6f5ac2>Front</span><span class="tag-item" data-v-6e6f5ac2>前端</span><span class="tag-item" data-v-6e6f5ac2>Babel</span></i> <span class="pageFull" data-v-6e6f5ac2>全屏</span></div></div> <div class="content__default"><h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2> <div class="tip custom-block"><p><code>Babel</code> 是一个 <code>JavaScript</code> 语言编辑器，平时我们主要用于将新标准的语法转换成为向后兼容的 <code>JavaScript</code> 语法，以便能在运行在我们想要兼容的环境中。</p></div> <p>以上是 <code>Babel</code> 的官方介绍，其实我们可以将其理解为一个加工机器。我们不关心机器内部的运行过程，只需要将我们的原料倒进机器中并开启按钮，便能生产出我们想要的产品来。 😏</p> <h2 id="原理分析"><a href="#原理分析" aria-hidden="true" class="header-anchor">#</a> 原理分析</h2> <p>在学习怎么编写 <code>Babel</code> 的插件之前，了解它对我们的原料做了什么工作有助于为我们编写插件提供思路。疏于了解时对于我们来说宛如黑魔法，待我将其拆解开，你会发现一切都是有迹可循。</p> <h3 id="babel-编译原理"><a href="#babel-编译原理" aria-hidden="true" class="header-anchor">#</a> Babel 编译原理 🎏</h3> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20190923-1.jpg" alt="齿轮"></p> <p>每个男孩可能都有那么一个梦想，将一个个零件通过自己的努力组装成为一台很酷的机器。拼什么机器不重要，只要酷就完事了。</p> <p>那么我跟你说，<code>Babel</code> 内部做的正是这一份拼装的工作，会不会觉得这个库做的东西其实一点都不枯燥，甚至还挺酷的呢。  😎</p> <p>我们都知道，<code>Babel</code> 帮我们做的是语法解析的工作，这项工作的前提是我们要能分析出完整的语法结构，接着才能进行对应的操作，那么大家对于分析语法结构有没有自己的做法呢？</p> <p><code>AST</code> 是计算机科学中一种用于词法解析的方法，其全称为抽象语法树（Abstract Syntax Tree），从命名可以看出这是一种将我们的语法抽象成为树状结构的方法。</p> <div class="tip custom-block"><p><code>AST</code> 不能完整表现真实语法的每个细节，完整表现的结构称为 <code>DST</code></p></div> <p>我们的 <code>Babel</code> 用的就是 <code>AST</code> 的工具来分析和编辑我们的代码结构。这时候可能有人会问了，<code>AST</code> 究竟是个什么东西啊？</p> <p>别急，后面我们就来会一会这个宛如黑魔法一般的技能吧！ 👊</p> <h3 id="ast-语法树"><a href="#ast-语法树" aria-hidden="true" class="header-anchor">#</a> AST 语法树 🎏</h3> <p>在开始讲述 <code>AST</code> 之前，有一个工具我想要推荐给大家，通过这么一个工具就可以轻松的将 <code>AST</code>, 的结构可视化，然后再据此进行操作。</p> <p><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">工具传送门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>AST 的原则就是将我们的代码分成尽可能小的词法块，然后将其用树的形式组织起来。</p> <p>通过 <code>AST</code> 我们可以把我们的任意程序都抽象成一棵树的形式来表示，并且通过这颗树能生成与原代码一样的代码集合。</p> <p>每一层结构在 <code>AST</code> 中被称为<code>节点（Node）</code>，他们拥有着相似的结构，下面我们用一个简单的例子来验证一下。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="tip custom-block"><p>本例中拆解出的 <code>AST</code> 以 <code>babylon7</code> 拆解出的 <code>AST</code> 为例</p></div> <p>这是个在 JavaScript 中简单的变量定义语法，我们先来对它进行简单的词法拆解。</p> <p>这一句话我们可以将其拆成 <code>var</code>、 <code>a</code>、 <code>1</code> 三个部分，画成图之后就变成了下面这样的结构：</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20190923-2.png" alt="AST结构1"></p> <p>可以看出来通过这么一个树形结构我们就把这么我们的代码给描述出来了，我们用上面提到的工具来验证一下我们生成出来的 AST 究竟是不是这样的吧 😏</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20190923-3png" alt="AST结构2"></p> <p>可以看出来，解析出来的 <code>AST</code> 跟我们拆解的基本一致，多出来的部分是对该词法的其他描述，用于定位语句位置以及其他标识工作。</p> <h3 id="编译原理"><a href="#编译原理" aria-hidden="true" class="header-anchor">#</a> 编译原理 🎏</h3> <p>Babel 工作的基本流程如下：</p> <ul><li>⭐️ 解析（parse）</li> <li>⭐️ 转换（transform）</li> <li>⭐️ 生成（generate）</li></ul> <p>虽然这一节的名称叫做编译原理，但并非教科书版本的编译原理。这里将给大家讲述通过 <code>AST</code> 修改代码的基本思路以及基本流程。</p> <p>思考下面一个例子，我们重新定义一个变量：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样我们就有了一个名字是 <code>b</code> 的变量，比较生成的 <code>AST</code> 树会发现变得只是定义的 <code>value</code> 从 <code>a</code> 变成了 <code>b</code>。</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20190923-4.png" alt="AST结构3"></p> <p>这样我们就有了编译的基础思路了，当我们想要把 <code>var a</code> 转换成 <code>var b</code>, 那我们只需要在 <code>AST</code> 树上找到对应的节点进行修改就行了。</p> <div class="tip custom-block"><p>我们这里把具体修改的方法先放一放，只需要有这么一种修改 <code>AST</code> 的意识即可。</p></div> <p>到了这里，我们已经能够进行简单的语法转换了。千里之行始于足下，再复杂的转换也是由这么一个小小的部分去组成的。</p> <p>工具完备后怎么使用就八仙过海各显神通了。</p> <h2 id="使用-babel-进行转换"><a href="#使用-babel-进行转换" aria-hidden="true" class="header-anchor">#</a> 使用 Babel 进行转换</h2> <p>前面已经给大家介绍过了 <code>AST</code> 的基本结构。对知识有了基础的概念之后我们可以开始着手编写我们的第一个插件了。</p> <h3 id="babel-基本使用"><a href="#babel-基本使用" aria-hidden="true" class="header-anchor">#</a> Babel 基本使用 🎏</h3> <p>相信 <code>Babel</code> 大家都使用过，现版本的 <code>Babel</code> 生态已经足够的好，深度集成在了各个我们常用的插件平台中。</p> <p>我们常用的 <code>vue-cli</code> 和 <code>react-create-app</code> 中的 <code>webpack</code> 中已经为我们集成好了 <code>Babel</code> 的相关配置，为我们带来了开箱即用的良好体验。</p> <p>虽然其在我们的项目中真的很不起眼，但从项目运行的角度说可以说是有着举足轻重的地位。</p> <p>不了解 <code>Babel</code> 的同学可以先补补课 <a href="https://www.babeljs.cn/docs/" target="_blank" rel="noopener noreferrer">&gt;&gt;&gt;传送门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><code>Babel</code> 向外暴露出的配置接口我们可以通过配置项目中的 <code>.babelrc</code> 文件进行配置，设置装载 <code>Babel</code> 预装的环境以及第三方的插件。</p> <h3 id="babel-api"><a href="#babel-api" aria-hidden="true" class="header-anchor">#</a> Babel API 🎏</h3> <p>之前已经介绍过，<code>Babel</code> 编译的实质是将其转为 <code>AST</code> 后对 <code>AST</code> 上的节点进行相应的操作后再将操作完成的 <code>AST</code> 重新编译成代码。</p> <p><code>Babel</code> 内部为我们提供了几个内置库以简化我们的操作：</p> <ul><li>babylon： 生成 <code>AST</code></li> <li>babel-register： 注册 <code>babel</code> 插件</li> <li>babel-traverse： 遍历 <code>AST</code> 树</li> <li>babel-types： 操作 <code>AST</code> 的工具库</li></ul> <p>在这里我们需要重点了解的是 <code>babel-types</code> 这个库，为我们封装了一套操作 <code>AST</code> 的逻辑，为我们提供了操作 <code>AST</code> 的基本能力。</p> <h3 id="vistor-api"><a href="#vistor-api" aria-hidden="true" class="header-anchor">#</a> Vistor API 🎏</h3> <p>这是我们编写插件前的最后一项理论基础了，<code>Babel</code> 定义了 <code>visitor</code> 对象用于插件访问生成的 <code>AST</code> 结构。</p> <p>在 <code>Babel</code> 插件的世界中所有的操作都是基于这一种模式。</p> <p>让我们先来看看教程中的一个例子：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token punctuation">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// visitor contents</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="tip custom-block"><p>Babel 遍历使用深度优先算法，所以每个节点都会被访问两次。 😏</p></div> <p>插件返回的是一个 <code>Babel</code> 的实例对象，这里为了方便我们直接使用对象结构取出 <code>babel.types</code> 并将其重命名为 <code>t</code>，所有的操作都在 <code>visitor</code> 中进行。</p> <p><code>visitor</code> 中操作的对象是固定的，我们来看看具体使用场景的例子：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token punctuation">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">ASTNodeTypeHere</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>从这个例子可以看出，实际上 <code>visitor</code> 是以节点名为单位对处理进行接收的，<code>Babel</code> 会对每一个该种节点都执行函数里的操作。</p> <div class="tip custom-block"><p>实际生产插件应考虑作用域问题。</p></div> <h2 id="第一个插件"><a href="#第一个插件" aria-hidden="true" class="header-anchor">#</a> 第一个插件</h2> <p>基础理论就绪以后，我们可以着手编写我们的第一个插件了。</p> <h3 id="环境准备"><a href="#环境准备" aria-hidden="true" class="header-anchor">#</a> 环境准备 🎏</h3> <p><code>Babel</code> 官方提供了一套脚手架 <code>babel-cli</code>，通过这一脚手架和上面提到的插件，我们就搭建起了我们编写插件的基本环境了。</p> <p>接着在 <code>node_modules</code> 文件夹中创建一个我们插件的文件夹，安装命名规范应为 <code>babel-plugin-xxx</code>，我们这里创建一个 <code>babel-plugin-first</code> 的文件夹，并在里面创建 <code>index.js</code> 文件。</p> <p>创建好了插件之后我们还需要在 <code>.babelrc</code> 中进行配置引入插件，配置如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;presets&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;plugins&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;first&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个时候我们的插件就已经应用成功啦~</p> <h3 id="第一个例子"><a href="#第一个例子" aria-hidden="true" class="header-anchor">#</a> 第一个例子 🎏</h3> <p>我们先来看一个我们刚才很熟悉的例子：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里我们起步的第一个例子就是将表达式中的 <code>const</code> 变成 <code>var</code>。</p> <p>我们应该怎么做呢？</p> <p>对的，我们先把他的 <code>AST</code> 结构打印出来看看:</p> <p><img src="https://blog-img-1252360401.cos.ap-guangzhou.myqcloud.com/20190923-6.png" alt="AST结构"></p> <p>从 <code>AST</code> 的结构可以看出，我们想要达到目的只需要将 <code>VariableDeclaration</code> 中的 <code>const</code> 换成 <code>var</code> 即可，思路非常简单，我们就直接来看代码了。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token punctuation">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">VariableDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> d <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>declarations<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">'const'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    t<span class="token punctuation">.</span><span class="token function">VariableDeclaration</span><span class="token punctuation">(</span><span class="token string">'var'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这时使用 <code>Babel</code> 对源代码进行编译会发现输出代码里的 <code>const</code> 已经被全部转成 <code>var</code> 了，以此类推我们能进行更加高级的工作。</p> <h3 id="箭头函数的替换"><a href="#箭头函数的替换" aria-hidden="true" class="header-anchor">#</a> 箭头函数的替换 🎏</h3> <p>箭头函数的替换相对比较高级，这里抽取官方库 <code>babel-plugin-transform-es2015-arrow-functions</code> 中的代码进行学习。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>__esModule <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_ref</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> t <span class="token operator">=</span> _ref<span class="token punctuation">.</span>types<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">ArrowFunctionExpression</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">ArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>spec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>shadow<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

          node<span class="token punctuation">.</span>shadow <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token comment">// 更换节点类型</span>
          node<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;FunctionExpression&quot;</span><span class="token punctuation">;</span>

          <span class="token comment">// 存储当前块级作用域 this 指向</span>
          <span class="token comment">// 绑定 this</span>
          <span class="token keyword">var</span> boundThis <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">thisExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          boundThis<span class="token punctuation">.</span>_forceShadow <span class="token operator">=</span> path<span class="token punctuation">;</span>

          <span class="token comment">// 生成块级作用域</span>
          path<span class="token punctuation">.</span><span class="token function">ensureBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 插入节点</span>
          path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unshiftContainer</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">addHelper</span><span class="token punctuation">(</span><span class="token string">&quot;newArrowCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">thisExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> boundThis<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 替换节点</span>
          path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">thisExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          path<span class="token punctuation">.</span><span class="token function">arrowFunctionToShadowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>关键代码解析：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 插入元素</span>
<span class="token comment">// 如果没有传参则默认插入在 body 下</span>
<span class="token keyword">function</span> <span class="token function">ensureBlock</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> key <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">&quot;body&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> node<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">toBlock</span><span class="token punctuation">(</span>node<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 插入影子函数节点</span>
<span class="token comment">// 默认编译成函数节点</span>
<span class="token keyword">function</span> <span class="token function">arrowFunctionToShadowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">;</span>

  node<span class="token punctuation">.</span>expression <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  node<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;FunctionExpression&quot;</span><span class="token punctuation">;</span>
  node<span class="token punctuation">.</span>shadow <span class="token operator">=</span> node<span class="token punctuation">.</span>shadow <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="结语"><a href="#结语" aria-hidden="true" class="header-anchor">#</a> 结语</h2> <p><code>Babel</code> 是前端工程狮们往底层进军的第一步，远离搬砖从学习 <code>AST</code> 开始。</p> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="https://www.babeljs.cn/" target="_blank" rel="noopener noreferrer">Babel中文网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#toc-writing-your-first-babel-plugin" target="_blank" rel="noopener noreferrer">Babel插件指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://segmentfault.com/a/1190000016231512?utm_source=tag-newest" target="_blank" rel="noopener noreferrer">AST<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <!----> <footer class="page-edit"><!----></footer> <!----> </main> <div class="valine-wrapper" data-v-5d2e7f84><div id="valine" data-v-5d2e7f84></div></div></div></div></div></div></div><div class="global-ui"><div class="reading-progress top" data-v-7681808f><div class="progress" data-v-7681808f></div></div></div></div>
    <script src="/assets/js/app.d305619e.js" defer></script><script src="/assets/js/3.23866648.js" defer></script><script src="/assets/js/2.e3159806.js" defer></script><script src="/assets/js/1.2ccdfbe4.js" defer></script><script src="/assets/js/55.6fe1c081.js" defer></script>
  </body>
</html>
